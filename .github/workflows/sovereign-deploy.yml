---
name: Sovereign Deploy - South Africa Only

"on":
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  VAULT_ID: ZA-BRICS-VAULT-GRID-BANK-001
  DEPLOYMENT_REGION: ZA
  JURISDICTION: BRICS

jobs:
  verify-sovereignty:
    name: Verify Quantum Law Anchor
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Vault Metadata
        run: |
          echo "üîê Validating Vault Metadata..."
          if [ ! -f "VAULT_METADATA.json" ]; then
            echo "‚ùå VAULT_METADATA.json not found!"
            exit 1
          fi

          # Verify required fields
          VAULT_ID=$(jq -r '.vault_id' VAULT_METADATA.json)
          REGION=$(jq -r '.quantum_law_anchor.region' VAULT_METADATA.json)
          JURISDICTION=$(jq -r '.quantum_law_anchor.jurisdiction' VAULT_METADATA.json)

          echo "‚úÖ Vault ID: $VAULT_ID"
          echo "‚úÖ Region: $REGION"
          echo "‚úÖ Jurisdiction: $JURISDICTION"

          if [ "$REGION" != "ZA" ]; then
            echo "‚ùå Invalid region. Must be ZA (South Africa)"
            exit 1
          fi

          if [ "$JURISDICTION" != "BRICS" ]; then
            echo "‚ùå Invalid jurisdiction. Must be BRICS"
            exit 1
          fi

          echo "‚úÖ Quantum Law Anchor verified"

  check-dependencies:
    name: Check Western Cloud Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Dependency Check
        run: |
          chmod +x .github/scripts/check-dependencies.sh
          .github/scripts/check-dependencies.sh

  multisig-verification:
    name: Verify 3-Key Multisig
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Required Approvals
        run: |
          echo "üîë Verifying 3-key multisig requirement..."
          echo "Required signatories:"
          echo "  1. Founder"
          echo "  2. Auditor"
          echo "  3. Planetary Node"
          echo ""
          echo "‚ö†Ô∏è  Manual verification required in PR reviews"

  deploy-za-nodes:
    name: Deploy to South African Nodes
    runs-on: ubuntu-latest
    needs: [verify-sovereignty, check-dependencies]
    if: github.ref == 'refs/heads/main'
    environment:
      name: south-africa-production
      url: https://za-node.vault-grid.brics
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Deployment Target
        run: |
          echo "üåç Verifying deployment to South African sovereign nodes..."
          echo "Target Region: South Africa (ZA)"
          echo "Jurisdiction: BRICS"
          echo ""
          echo "üöÄ Deployment nodes:"
          jq -r '.quantum_law_anchor.sovereign_nodes[]' VAULT_METADATA.json

      - name: Deploy to ZA Node 01 - Johannesburg
        run: |
          echo "üì° Deploying to za-johannesburg-node-01..."
          echo "Status: ‚úÖ Simulated deployment successful"

      - name: Deploy to ZA Node 02 - Cape Town
        run: |
          echo "üì° Deploying to za-cape-town-node-02..."
          echo "Status: ‚úÖ Simulated deployment successful"

      - name: Deploy to ZA Node 03 - Durban
        run: |
          echo "üì° Deploying to za-durban-node-03..."
          echo "Status: ‚úÖ Simulated deployment successful"

      - name: Verify Deployment
        run: |
          echo "‚úÖ All South African nodes deployed successfully"
          echo "üõ°Ô∏è  Sovereign verification complete"
          echo "üáøüá¶ System operational on South African soil"

  # Explicitly block non-sovereign deployments
  block-western-deployment:
    name: Block Western Cloud Deployment
    runs-on: ubuntu-latest
    steps:
      - name: Prevent Western Cloud Access
        run: |
          echo "üö´ Western cloud deployments are PROHIBITED"
          echo "‚úÖ This workflow only deploys to South African sovereign infrastructure"
          echo "üìã Blocked regions: US, EU, Five Eyes nations"
          echo "üåç Allowed regions: South Africa, BRICS nations"
